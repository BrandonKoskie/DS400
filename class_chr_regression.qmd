---
title: "CHR"
format: html
editor: visual
---

## üåê üåΩ County Health Rankings w/ Bayesian Regression

### Libraries

```{r}
library(tidyverse)
library(janitor)
library(rstanarm)
library(here)
library(readxl)
library(plotly)
library(tigris)
library(sf)
library(viridis)
```

### Data

```{r}
chr_data <- read_excel(here("data/2025_County_Health_Rankings_Data.xlsx"), sheet = 2, skip = 1)
```

```{r}
chr_data <- chr_data %>% 
  clean_names()
```

#### Regression Variables of Interest

-   `food_environment_index`

    -   The **Food Environment Index (FEI)** is a **County Health Rankings** composite (0‚Äì10 scale, where **10 = best**) that summarizes how easy it is for people in a county to get enough **healthy, affordable food**.

        It combines two pieces of information:

        1.  **Food insecurity** ‚Äì the estimated share of residents who lack reliable access to enough food.

        2.  **Limited access to healthy foods** ‚Äì the share of people who are **low-income and far from a grocery store** (typically ‚â•1 mile in urban areas or ‚â•10 miles in rural areas).

            These components are blended and rescaled to 0‚Äì10:

            **Higher FEI (closer to 10)** ‚Üí lower food insecurity and better physical access to healthy food.

            **Lower FEI (closer to 0)** ‚Üí more food insecurity and poorer access (more ‚Äúfood deserts‚Äù).

-   `percent_fair_or_poor_health`

    -   a County Health Rankings (CHR) indicator from the BRFSS survey:

        -   **What it is:** the **percentage of adults** who answer **‚Äúfair‚Äù or ‚Äúpoor‚Äù** to the question, ‚ÄúIn general, would you say your health is excellent, very good, good, fair, or poor?‚Äù

Simplify dataframe to select columns of interest

```{r}
chr_data_simplified <- chr_data %>% 
  select(state, county, food_environment_index, percent_fair_or_poor_health)
```

### Simple scatter plot, linear model

```{r}
ggplot(chr_data_simplified, aes(x = food_environment_index, y = percent_fair_or_poor_health)) +
  geom_point(alpha = 0.1) +
  geom_smooth()
```

```{r}
lm(percent_fair_or_poor_health ~ food_environment_index, chr_data_simplified)
```

### Priors

Literature-Informed Priors: Fair/Poor Health \~ Food Environment Index

Empirical Background

Several studies using BRFSS, County Health Rankings (CHR), or linked datasets find that better local food access is associated with lower rates of poor self-rated health.

| Parameter | Prior (percent scale) | What it encodes | Literature tie-in |
|------------------|------------------|------------------|------------------|
| **Intercept (Œ≤‚ÇÄ)** | `Normal(17, 4)` | At **average FEI**, a typical county has \~**17%** fair/poor health (95% prior ‚âà **9‚Äì25%**) | BRFSS/CHR descriptive range (‚âà14‚Äì20% typical); compatible with Berkowitz (food insecurity ‚Üî higher % fair/poor) |
| **Slope (Œ≤‚ÇÅ)** | `Normal(-1.3, 0.6)` *(pp per +1 FEI)* | Each **+1 FEI** is expected to **reduce** fair/poor health by **\~1.3 percentage points** on average (95% prior ‚âà **‚àí2.5 to ‚àí0.1** pp) | **Fan & Jin (2022)** report ‚àí**1.3 pp** per +1 FEI; **Liese et al. (2014)** (odds ‚âà1.1√ó worse per unit) implies ‚âà **‚àí1 to ‚àí1.6 pp** per +1 FEI near 15‚Äì20% baseline |
| **Residual SD (œÉ)** | `Exponential(1/4.5)` | Mean residual scatter ‚âà **4.5 percentage points** (allows substantial county heterogeneity) | County-level BRFSS/CHR models often show **4‚Äì6 pp** residual SD after single-predictor adjustment |

### Simulation with rstanarm

```{r}
health_model <- stan_glm(percent_fair_or_poor_health ~ food_environment_index, data = chr_data_simplified,
                       family = gaussian,
                       prior_intercept = normal(17, 4),
                       prior = normal(-1.3, 0.6), 
                       prior_aux = exponential(1/4.5),
                       chains = 4, iter = 5000*2, seed = 84735)
```

```{r}
health_model
```

‚Üí Each **+1** in **Food Environment Index** is associated with **\~2.6 percentage-point lower** fair/poor health, on average.

**Residual SD (sigma)** = **3.6 pp**: after accounting for FEI, counties typically vary by about ¬±3‚Äì4 percentage points around the line.

### Challenge

Make a map describing the **Food Environment Index** in the US

```{r}
us_counties <- counties(cb = TRUE, year = 2022) %>%
  st_as_sf() %>%
  mutate(
    state = str_to_title(STATE_NAME),
    county = str_remove_all(NAME, " County")
  )
```

```{r}
fe_data <- chr_data_simplified %>%
  mutate(
    state = str_to_title(state),
    county = str_remove_all(county, " County")
  )
```

```{r}
map_data <- us_counties %>%
  left_join(fe_data, by = c("state", "county"))

```

```{r}
ggplot(map_data) +
  geom_sf(aes(fill = food_environment_index), color = NA) +
  scale_fill_viridis(
    name = "Food Environment Index",
    option = "C",
    limits = c(0, 10),
    na.value = "gray90"
  ) +
  labs(
    title = "Food Environment Index by County (United States)",
    subtitle = "Higher values indicate better access to healthy food and lower food insecurity",
    caption = "Source: County Health Rankings (CHR)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

```

```{r}
# Base ggplot map
p <- ggplot(map_data) +
  geom_sf(aes(fill = food_environment_index,
              text = paste0(county, ", ", state, "<br>",
                            "FEI: ", round(food_environment_index, 1))),
          color = NA) +
  scale_fill_viridis_c(
    name = "Food Environment Index",
    option = "C",
    limits = c(0, 10),
    na.value = "gray90"
  ) +
  labs(
    title = "Food Environment Index by County (Contiguous U.S.)",
    subtitle = "Higher values indicate better access to healthy food",
    caption = "Source: County Health Rankings"
  ) +
  theme_void() +
  theme(legend.position = "bottom")

# Convert to interactive plotly
fig <- ggplotly(p, tooltip = "text")

fig

```
